<!-- anime.ejs -->
 <head>
  <!-- Add to your anime.ejs above the <form> -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/styles.css">
<title>Which Anime Should I Watch Next?</title>
 </head>

 <body>
<h1>Which Anime Should I Watch Next?</h1>
<p>Adjust the filters to find the anime you want to watch next!</p>

<form class="container mb-4" method="GET" action="/">
  <div class="row g-3 align-items-end">
    
    <!-- Status -->
    <div class="col-md-3">
      <label>Status</label>
      <select name="status" class="form-select">
        <option value="">All</option>
        <option value="FINISHED" <%= req.query.status === 'FINISHED' ? 'selected' : '' %>>Complete</option>
        <option value="RELEASING" <%= req.query.status === 'RELEASING' ? 'selected' : '' %>>Ongoing</option>
      </select>
    </div>

    <!-- Genre -->
    <div class="col-md-3">
      <label>Genre</label>
      <select name="genre" class="form-select">
        <option value="">All</option>
        <% const genres = ['Action', 'Adventure', 'Comedy', 'Drama', 'Fantasy', 'Horror', 'Romance', 'Sci-Fi', 'Slice of Life', 'Sports', 'Thriller']; %>
        <% genres.forEach(genre => { %>
          <option value="<%= genre %>" <%= req.query.genre === genre ? 'selected' : '' %>><%= genre %></option>
        <% }) %>
      </select>
    </div>

    <!-- Streaming Service -->
    <div class="col-md-3">
      <label>Streaming Service</label>
      <select name="service" class="form-select">
        <option value="">All</option>
        <% const services = ['Crunchyroll', 'Funimation', 'Netflix', 'Hulu', 'Amazon Prime', 'HiDive']; %>
        <% services.forEach(service => { %>
          <option value="<%= service %>" <%= req.query.service === service ? 'selected' : '' %>><%= service %></option>
        <% }) %>
      </select>
    </div>

    <!-- Year -->
<div class="col-md-3">
  <label>Year</label>
  <input type="number" name="year" class="form-control" placeholder="e.g. 2022" min="1900" max="2100" value="<%= req.query.year || '' %>">
</div>

<!-- Min Episodes -->
<div class="col-md-3">
  <label>Min Episodes</label>
  <input type="number" name="minEpisodes" class="form-control" placeholder="e.g. 12" min="1" value="<%= req.query.minEpisodes || '' %>">
</div>

<!-- Max Episodes -->
<div class="col-md-3">
  <label>Max Episodes</label>
  <input type="number" name="maxEpisodes" class="form-control" placeholder="e.g. 100" min="1" value="<%= req.query.maxEpisodes || '' %>">
</div>

    <!-- Minimum Rating -->
    <div class="col-md-3">
      <label>Minimum Rating</label>
      <input type="number" name="minScore" class="form-control" placeholder="out of 100" min="0" max="100" value="<%= req.query.minScore || '' %>">
    </div>

    <div class="col-md-12 text-end mt-3">
      <button class="btn btn-primary">Apply Filters</button>
    </div>
  </div>
</form>

<div class="container mt-5">
  <div class="row row-cols-1 row-cols-md-3 g-4">
    <% anime.forEach(show => { %>
      <div class="col">
  <div class="card h-100 shadow-sm position-relative">
    <img src="<%= show.coverImage.extraLarge || show.coverImage.large %>" class="img-fluid mb-3">
    <div class="card-body d-flex flex-column">
      <h5 class="card-title"><%= show.title.english || show.title.romaji %></h5>
      <p class="card-text mb-1">
        <%= show.description?.replace(/<br><br>\(Source:.*?\)/, '').slice(0, 100) %>...
      </p>
      <p class="card-text small text-muted mb-0">
  <%= show.startDate?.year || 'Year N/A' %> | <%= show.episodes || '?' %> episodes
</p>
      <p class="text-warning fw-semibold mb-2">⭐ <%= show.averageScore || 'N/A' %>/100</p>
      <ul class="list-unstyled mt-auto">
        <% show.externalLinks.forEach(link => { %>
          <li><a href="<%= link.url %>" target="_blank"><%= link.site %></a></li>
        <% }) %>
      </ul>
    </div>
    <!-- Trigger modal: covers the whole card -->
    <button type="button" class="btn btn-link stretched-link p-0 m-0 position-absolute top-0 start-0 w-100 h-100" 
  data-bs-toggle="modal" data-bs-target="#animeModal<%= show.id %>">
</button>
  </div>
</div>
    <% }) %>
  </div>
</div>

<% anime.forEach(show => { %>
  <div class="modal fade" id="animeModal<%= show.id %>" tabindex="-1" aria-labelledby="animeModalLabel<%= show.id %>" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="animeModalLabel<%= show.id %>"><%= show.title.english || show.title.romaji %></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <img src="<%= show.coverImage.large %>" class="img-fluid mb-3">
          <p><%- show.description?.replace(/<br\s*\/?>/g, '<br>')?.replace(/\(Source:.*?\)/, '') %></p>
          <% if (show.externalLinks && show.externalLinks.length) { %>
  <a href="<%= show.externalLinks[0].url %>" class="btn btn-primary mt-3" target="_blank">Watch Now</a>
<% } %>
        </div>
      </div>
    </div>
  </div>
<% }) %>

<footer class="text-center text-muted mt-5 mb-3">
  <small>Some links are affiliate links. If you use them, I may earn a commission—at no extra cost to you. Thanks!</small>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
<!-- affiliate links need updating, when card is selected show full description - currently shows only the first regardless of whuch card is selected-->